// Auto-generated from index.html.
// DO NOT EDIT.

library index_html;

import 'dart:html' as autogenerated;
import 'dart:svg' as autogenerated_svg;
import 'package:web_ui/web_ui.dart' as autogenerated;
import 'package:web_ui/observe/observable.dart' as __observe;
import 'dart:html';
import 'dart:math' as math;
import 'dart:async';
import 'package:web_ui/web_ui.dart';
import 'package:ld48/ld48.dart';


// Original code


final __changes = new __observe.Observable();

dynamic __$abbrevs = new AbbrevsSelection();
dynamic get abbrevs {
  if (__observe.observeReads) {
    __observe.notifyRead(__changes, __observe.ChangeRecord.FIELD, 'abbrevs');
  }
  return __$abbrevs;
}
set abbrevs(dynamic value) {
  if (__observe.hasObservers(__changes)) {
    __observe.notifyChange(__changes, __observe.ChangeRecord.FIELD, 'abbrevs',
        __$abbrevs, value);
  }
  __$abbrevs = value;
}

dynamic __$abbrev = "";
dynamic get abbrev {
  if (__observe.observeReads) {
    __observe.notifyRead(__changes, __observe.ChangeRecord.FIELD, 'abbrev');
  }
  return __$abbrev;
}
set abbrev(dynamic value) {
  if (__observe.hasObservers(__changes)) {
    __observe.notifyChange(__changes, __observe.ChangeRecord.FIELD, 'abbrev',
        __$abbrev, value);
  }
  __$abbrev = value;
}

dynamic __$abbrevSample = "";
dynamic get abbrevSample {
  if (__observe.observeReads) {
    __observe.notifyRead(__changes, __observe.ChangeRecord.FIELD, 'abbrevSample');
  }
  return __$abbrevSample;
}
set abbrevSample(dynamic value) {
  if (__observe.hasObservers(__changes)) {
    __observe.notifyChange(__changes, __observe.ChangeRecord.FIELD, 'abbrevSample',
        __$abbrevSample, value);
  }
  __$abbrevSample = value;
}

dynamic __$lastStepText = "";
dynamic get lastStepText {
  if (__observe.observeReads) {
    __observe.notifyRead(__changes, __observe.ChangeRecord.FIELD, 'lastStepText');
  }
  return __$lastStepText;
}
set lastStepText(dynamic value) {
  if (__observe.hasObservers(__changes)) {
    __observe.notifyChange(__changes, __observe.ChangeRecord.FIELD, 'lastStepText',
        __$lastStepText, value);
  }
  __$lastStepText = value;
}

var scope = 2/3;
var sortedSelected = null;

var player1;

var pFastest;

var pSlowest;

var rHide = new math.Random();

var _bonusPlayed = -1;
var _bonusTimer = null;

@observable
get score {
  if (player1 == null) return 0;
  while (!pSlowest.isFinished && !pFastest.isFinished){
    tryAbbrev('');
  }
  return math.max(0, pSlowest.nbStep - player1.nbStep) * 100 /math.max(1, pFastest.nbStep - pSlowest.nbStep);
}
/**
 * Learn about the Web UI package by visiting
 * http://www.dartlang.org/articles/dart-web-components/.
 */
void main() {
  // Enable this to use Shadow DOM in the browser.
  //useShadowDom = true;
  //new Timer(const Duration(), () {
    player1 = new Player("player1");
    pFastest = new PlayerIA("pFastest");
    pSlowest = new PlayerIA("pSlowest");
    reset();
  //});
}
//TODO make testcase (with random generator of k : ala QuickCheck)
bool tryAbbrev() {
  var k = abbrev;
  var a = (k.isEmpty)? null : abbrevs.tryAbbrev(k);
  if (a == null && (_bonusPlayed == 0)&& abbrevs.abbrevBonus.short == k) {
    a = abbrevs.abbrevBonus;
    _bonusPlayed = 1;
  }
  player1.step(a);
  pFastest.stepNext();
  pSlowest.stepNext();
  var railsW = toWPixel(query("#rails"));
  player1.positionLeft(railsW);
  pFastest.positionLeft(railsW);
  pSlowest.positionLeft(railsW);
  if (a != null) {
    abbrev = '';
    queryAll(".abb_${a.id}").forEach((Element abbrevEl){
      abbrevEl.classes.remove("show0");
      abbrevEl.classes.add("hide${rHide.nextInt(6)}");
    });
  }
  lastStepText = (a == null)? "not found = +0":"'${a.long}' x ${a.nbOccurences} = +${a.score}";
  if (player1.isFinished) finish();
  return false;
}

playBonus() {
  if (_bonusPlayed != -1) return;
  _bonusPlayed = 0;
  var el = new Element.tag("div");
  el.classes.add("abb_${abbrevs.abbrevBonus.id}");
  el.classes.add("abbrevBonus");
  el.style.top = "50%";
  el.style.right = "0%";
  el.text = abbrevs.abbrevBonus.long;
  query("#abbrevs").children.add(el);
  el.classes.add("playBonus");
}

reset() {
  abbrev = "";
  abbrevs.selectFrom(Abbrevs.generateTestSL(50));
  var total = abbrevs.selected.fold(0, (acc, a) => acc += a.score) * scope;
  var sortedSelected = abbrevs.selected.toList(growable: false)..sort(Abbrev.compareScore);
  abbrevSample = sortedSelected.isEmpty ? '' : sortedSelected[0].short;
  _bonusPlayed = -1;
  if (_bonusTimer != null){
    _bonusTimer.cancel();
    _bonusTimer = null;
  }

  // should take care of the width and height of sequence
  new Timer(const Duration(milliseconds:500), (){
    var r = new math.Random();
    var abs = query("#abbrevs");
    //var w = abs.clientWidth;
    //var h = abs.clientHeight;
    abs.children.forEach((Element abbrevEl){
      abbrevEl.classes.add("show0");
      abbrevEl.style.top = "${r.nextDouble() * 90}%";
      abbrevEl.style.left = "${r.nextDouble() * 90}%";
      // failed to use transform : run as expetec until we start animation that ignore previous translation,...
      //abbrevEl.style.transform = "translate(${((r.nextDouble() * 0.9) - 0.5)* w}px,${((r.nextDouble() * 0.9) - 0.5)* h}px)";
    });
    if (r.nextBool()) {
      var t = new Duration(seconds:r.nextInt(180) + 1);
      //var t = const Duration(seconds:1);
      _bonusTimer = new Timer(t, playBonus);
    }
  });

  player1.reset(total);

  pFastest.sequence = sortedSelected;
  pFastest.reset(total);

  pSlowest.sequence = sortedSelected.reversed.toList();
  pSlowest.reset(total);

  var railsW = toPixel(query("#rails").getComputedStyle().width);
  player1.positionLeft(railsW);
  pFastest.positionLeft(railsW);
  pSlowest.positionLeft(railsW);
}

finish() {
  print("FINISH");
  if (_bonusTimer != null){
    _bonusTimer.cancel();
    _bonusTimer = null;
  }
}
// Additional generated code
void init_autogenerated() {
  var _root = autogenerated.document.body;
  final __html0 = new autogenerated.Element.html('<div template="" repeat="abbrev in abbrevs.selected2" class="abbrev " style="top:50%; left:50%"></div>');
  var __e0, __e1, __e3, __e6;
  var __t = new autogenerated.Template(_root);
  __e0 = _root.nodes[1].nodes[3];
  __t.listen(__e0.onInput, ($event) { abbrev = __e0.value; });
  __t.bind(() => abbrevSample,  (__e) { __e0.placeholder = 'abbreviation or acronym (eg: ${__e.newValue} )'; }, false);
  __t.oneWayBind(() => abbrev, (e) { if (__e0.value != e) __e0.value = e; }, false, false);
  __e1 = _root.nodes[1].nodes[5];
  __t.listen(__e1.onClick, ($event) { tryAbbrev(); });
  __e3 = _root.nodes[1].nodes[7];
  var __binding2 = __t.contentBind(() => lastStepText, false);
  __e3.nodes.add(__binding2);
  __e6 = _root.nodes[5].nodes[1];
  __t.loop(__e6, () => abbrevs.selected2, ($list, $index, __t) {
    var abbrev = $list[$index];
    var __e5;
    __e5 = __html0.clone(true);
    var __binding4 = __t.contentBind(() => abbrev.long, false);
    __e5.nodes.add(__binding4);
    __t.bindClass(__e5, () => 'abb_' + abbrev.id, false);
  __t.add(__e5);
  });
  __t.create();
  __t.insert();
}

//@ sourceMappingURL=index.dart.map